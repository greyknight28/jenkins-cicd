# ===============================
# Azure DevOps CI/CD Pipeline
# ===============================
# This pipeline builds a Docker image, pushes it to ACR,
# and deploys it to AKS using kubectl.
# ===============================

trigger:
- main   # Change branch if needed

variables:
  # Customize these values
  acrName: 'myacr123'                     # ACR name (without .azurecr.io)
  acrLoginServer: 'myacr123.azurecr.io'   # ACR login server
  imageName: 'sample-app'
  aksResourceGroup: 'myResourceGroup'     # Resource group containing AKS
  aksClusterName: 'myAKSCluster'          # AKS cluster name
  kubernetesManifest: 'deployment.yaml'
  tag: '$(Build.BuildId)'

stages:
# ===============================
# 1️⃣ BUILD STAGE
# ===============================
- stage: Build
  displayName: "Build & Push Docker Image"
  jobs:
  - job: BuildAndPush
    displayName: "Build and Push Image to ACR"
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - checkout: self

    # Login to Azure
    - task: AzureCLI@2
      displayName: "Login to Azure"
      inputs:
        azureSubscription: 'MyServiceConnection'   # Service Connection name
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          echo "Logged into Azure Subscription"

    # Login to ACR
    - task: AzureCLI@2
      displayName: "Login to ACR"
      inputs:
        azureSubscription: 'MyServiceConnection'
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          az acr login --name $(acrName)

    # Build and Push Docker Image
    - task: Docker@2
      displayName: "Build and Push Docker Image"
      inputs:
        containerRegistry: 'MyACRServiceConnection'   # Docker registry service connection
        repository: '$(imageName)'
        command: 'buildAndPush'
        Dockerfile: 'Dockerfile'
        tags: |
          $(tag)
          latest

    # Replace image name in manifest dynamically
    - task: Bash@3
      displayName: "Update Kubernetes Manifest with Image Tag"
      inputs:
        targetType: 'inline'
        script: |
          echo "Updating image in manifest file..."
          sed -i "s|image:.*|image: $(acrLoginServer)/$(imageName):$(tag)|g" $(kubernetesManifest)
          echo "Updated manifest:"
          cat $(kubernetesManifest)

    # Publish artifact for deploy stage
    - task: PublishPipelineArtifact@1
      displayName: "Publish Kubernetes Manifests"
      inputs:
        targetPath: '$(System.DefaultWorkingDirectory)'
        artifact: 'manifests'

# ===============================
# 2️⃣ DEPLOY STAGE
# ===============================
- stage: Deploy
  displayName: "Deploy to AKS"
  dependsOn: Build
  jobs:
  - job: DeployToAKS
    displayName: "Apply Kubernetes Manifests"
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - checkout: self

    - download: current
      artifact: manifests

    # Connect to AKS
    - task: AzureCLI@2
      displayName: "Connect to AKS"
      inputs:
        azureSubscription: 'MyServiceConnection'
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          echo "Getting AKS credentials..."
          az aks get-credentials --resource-group $(aksResourceGroup) --name $(aksClusterName) --overwrite-existing
          echo "Verifying connection..."
          kubectl get nodes

    # Deploy to AKS
    - task: Kubernetes@1
      displayName: "Deploy Application to AKS"
      inputs:
        connectionType: 'None'
        command: 'apply'
        useConfigurationFile: true
        configuration: '$(Pipeline.Workspace)/manifests/$(kubernetesManifest)'

    # Verify deployment
    - task: Bash@3
      displayName: "Verify Deployment"
      inputs:
        targetType: 'inline'
        script: |
          kubectl get pods -o wide
          kubectl get svc -o wide
